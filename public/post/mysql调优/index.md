# MySQL调优


MyIsam和InnoDB区别

存储引擎的统计数据是精确的

## 什么是MySQL调优

MySQL调优是指对MySQL数据库进行性能优化的一系列操作，旨在提高数据库的运行效率、响应速度和稳定性。简单来说MySQL调优就是将原本执行较慢的SQL语句，通过一些列的优化转换成执行相对较快的SQL语句。

在MySQL的各种语句中（SELECT UPDATE INSERT DROP），SELECT语句往往是最需要进行调优的

## 调优金字塔

MySQL调优可以从多个方面进行，包括架构调优、MySQL本身调优、硬件调优

<img src="C:\Users\丁元广\AppData\Roaming\Typora\typora-user-images\image-20240530211322891.png" alt="image-20240530211322891" style="zoom: 67%;" />

越往上成本、难度越来越高，但是带来的收益却是越来越小，所以在优化时，往往优先考虑下方的优化方式

> 架构调优

1. 在进行架构设计时，首先要考虑业务的实际情况，是否可以把不适合数据库做的事情放在其他服务中，如数据仓库、搜索引擎、数据缓存等等
2. 考虑数据库的并发量是否较大，是否采用分布式架构
3. 考虑读的压力是否较大，是否需要读写分离

> MySQL调优

1. 设计合理的表结构
2. 优化SQL语句
3. 添加索引

> 硬件调优

这个一般不需要太多的关注，如果是DBA的话，需要自己去学一些操作系统和硬件的知识

## 慢查询

### 什么是慢查询

慢查询就是一条SELECT语句执行需要花费大量时间，这个时间往往不被系统或用户能接受（比如10s钟）

在MySQL中慢查询就是指执行时间超过MySQL服务器所设定的`long_quer_time`时间的SELECT语句，所有超过该时间的语句都会被记录在慢查询日志中。

在MySQL中可以通过`show VARIABLES like '%slow_query_time%'` `set global long_query_time=0`来查看和设置慢查询的时间阈值。（设置为0，就表示任何查询都是慢查询，都会被记录在慢查询日志中）

在MySQL中可以通过`show VARIABLES like 'slow_query_log'`和`set GLOBAL slow_query_log=1`来查询和开启慢查询日志，如果慢查询日志没有开启，则不会被记录。

如果希望将没有使用索引的SELECT语句也记录在慢查询日志中，可以通过`set VARIABLES 'log_queries_not_using_indexes'`来开启

在MySQL中通过`show VARIABLES like '%slow_query_log_file%'`来查看慢日志所在的磁盘位置

### 为何会产生慢查询

其实产生慢查询的最终原因就是因为MySQL服务器要扫描的数据过多，这里可以是因为要扫描的数据行过多，也可能是因为要返回的数据列过多。所以MySQL调优主要是尽可能的让MySQL服务器只扫描自己需要的数据，不去扫描额外的数据，这样就能将MySQL性能发挥到最大。

> 几个概念

1. 响应时间：响应时间是指语句执行所花费的时间，它由服务时间和排队时间两个部分组成
   - 排队时间是指服务器因为等待某些资源而没有真正执行查询的时间，可能是等待IO操作完成，或等待行锁
   - 服务时间是指这条SELECT语句真正执行的时间
2. 扫描行数：MySQL为了找到目标的数据，在服务器中所扫描的记录数
3. 返回行数：最终需要的记录数

显然对于一条SELECT语句，响应时间越短越好，扫描行数与返回行数的比，越小越好，但是最小是1，即扫描多少条数据，返回多少条数据

如果发现查询需要扫描大量的数据，但是只返回少量的数据，那么可以通过下面几种方法尝试优化：

1. 使用覆盖索引，把所有需要使用的列都放到索引中，减少回表次数
2. 改变库表结构，例如使用汇总表
   - 这个查询频繁使用，访问大量数据并进行复杂计算
   - 对实时性要求不高，可以接受一定程度的延迟更新汇总数据
3. 如果SELECT较为复杂，可以尝试重写优化，让MySQL优化器能够以更优化的方式执行这个查询

**注意**：在一条SELECT语句中，除非特殊情况，否则一定要避免使用`SELECT * FROM table`，最好是按需查询。我自己在刚工作时，就遇到过这种情况，在一张有两万多条记录的表中，有四五条记录的一个字段数据非常大（大约几MB），所以我当时使用`SELECT *`时，一直报慢查询相关错误，恰巧这个字段我并不需要。但是后面还是有大佬通过一些压缩算法把数据压缩了。

## 执行计划

前面说了慢查询会被记录在慢查询日志中，那么如何排查这条慢查询是因何而导致呢？是因为没有使用索引？还是因为扫描的记录数较多？又或是因为等待锁？这时候
